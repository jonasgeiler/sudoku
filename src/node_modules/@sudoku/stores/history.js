import { writable } from 'svelte/store';

function createHistoryStore() {
  const { subscribe, set, update } = writable({
    past: [],
    future: [],
    current: null
  });

  return {
    subscribe,
    // 记录新的操作
    recordMove: (move) => update(state => {
      if (!move) return state;
      
      // 记录当前状态到历史
      const newPast = state.current ? 
        [...state.past, state.current] : 
        [...state.past];
      
      return {
        past: newPast,
        current: move,
        future: [] // 新操作时清空future
      };
    }),

    // 撤销操作
    undo: () => update(state => {
      if (state.past.length === 0) return state;
      
      // 获取最后一个历史状态
      const previous = state.past[state.past.length - 1];
      
      return {
        past: state.past.slice(0, -1),
        current: previous,
        future: state.current ? [state.current, ...state.future] : state.future
      };
    }),

    // 重做操作
    redo: () => update(state => {
      if (state.future.length === 0) return state;
      
      const next = state.future[0];
      
      return {
        past: state.current ? [...state.past, state.current] : state.past,
        current: next,
        future: state.future.slice(1)
      };
    }),

    // 清空历史记录
    clear: () => set({
      past: [],
      current: null,
      future: []
    })
  };
}

export const history = createHistoryStore();